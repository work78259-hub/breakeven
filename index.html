<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BREAK EVEN ANALYSIS</title>

  <style>
    :root{
      --bg:#f3f4f6;
      --grid:#111;
      --yellow:#fff36a;
      --cream:#fff7df;
      --blue:#cfe6f6;
      --green:#d9ead3;
      --peach:#f3d6d6;
      --section:#f7d37a;
      --white:#fff;
      --muted:#6b7280;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
    }

    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 14px;
      padding-bottom: 28px;
    }

    .sheet{
      width: 100%;
      border: 2px solid var(--grid);
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }

    .title{
      text-align:center;
      font-weight: 800;
      padding: 10px 8px;
      border-bottom: 2px solid var(--grid);
      background: #fff;
      letter-spacing: .3px;
    }

    table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    td{
      border: 2px solid var(--grid);
      padding: 8px 8px;
      text-align: center;
      vertical-align: middle;
      font-weight: 700;
    }

    .leftTag{
      width: 74px;
      font-weight: 900;
    }

    .peach{ background: var(--peach); }
    .sectionYellow{ background: var(--section); }
    .cream{ background: var(--cream); }
    .blue{ background: var(--blue); }
    .green{ background: var(--green); }
    .yellow{ background: var(--yellow); }

    .cellInput{
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      text-align: center;
      font-size: 18px;
      font-weight: 900;
      padding: 2px 0;
    }

    .cellOut{
      font-size: 18px;
      font-weight: 900;
    }

    .small{
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.35;
    }

    /* Mobile friendliness */
    @media (max-width: 420px){
      td{ padding: 7px 6px; }
      .leftTag{ width: 64px; }
      .cellInput, .cellOut{ font-size: 16px; }
    }

    /* PIN overlay */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .pinCard{
      width: min(420px, 100%);
      background: #fff;
      border-radius: 18px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    .pinTitle{ font-size: 18px; margin: 0 0 6px; font-weight: 900; }
    .pinHelp{ margin: 0 0 12px; color: #6b7280; font-size: 13px; line-height: 1.3; }
    .pinRow{ display:flex; gap:10px; }
    .pinRow input{
      flex:1;
      height: 52px;
      font-size: 18px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      outline:none;
    }
    .pinRow button{
      height: 52px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid #111;
      background: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
    }
    .pinErr{
      margin-top: 10px;
      font-size: 13px;
      color: #b91c1c;
      min-height: 18px;
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <!-- PIN -->
  <div class="overlay" id="pinOverlay">
    <div class="pinCard">
      <div class="pinTitle">Enter PIN</div>
      <p class="pinHelp">PIN を入力してください</p>
      <div class="pinRow">
        <input id="pinInput" inputmode="numeric" placeholder="1234" />
        <button id="pinBtn">Unlock</button>
      </div>
      <div class="pinErr" id="pinErr"></div>
    </div>
  </div>

  <div class="wrap hidden" id="app">
    <div class="sheet">
      <div class="title">BREAK EVEN ANALYSIS - 損益分岐分析</div>

      <table>
        <!-- 内外 -->
        <tr>
          <td class="leftTag peach" rowspan="4">内外</td>
          <td class="cream">仕入</td>
          <td class="cream">売値¥</td>
          <td class="cream">売値$</td>
        </tr>
        <tr>
          <td class="yellow">
            <input class="cellInput" id="domBuyY" type="number" inputmode="decimal" step="0.01">
          </td>
          <td class="cream"><div class="cellOut" id="domSellYkgFromBuy">—</div></td>
          <td class="cream"><div class="cellOut" id="domSellUsdTonFromBuy">—</div></td>
        </tr>
        <tr>
          <td class="cream">仕入</td>
          <td class="cream">売値¥</td>
          <td class="cream">売値$</td>
        </tr>
        <tr>
          <td class="cream"><div class="cellOut" id="domBuyYFromSell">—</div></td>
          <td class="cream"><div class="cellOut" id="domSellYkgFromSell">—</div></td>
          <td class="yellow">
            <input class="cellInput" id="domSellUsd" type="number" inputmode="decimal" step="0.01">
          </td>
        </tr>

        <!-- 外外 -->
        <tr>
          <td class="leftTag sectionYellow" rowspan="4">外外</td>
          <td class="blue">仕入$</td>
          <td class="blue">OF/TON</td>
          <td class="blue">売値$</td>
        </tr>
        <tr>
          <td class="yellow">
            <input class="cellInput" id="osBuyUsd" type="number" inputmode="decimal" step="0.01">
          </td>
          <td class="blue"><div class="cellOut" id="ofUsdTonA">—</div></td>
          <td class="blue"><div class="cellOut" id="osSellUsdTonFromBuy">—</div></td>
        </tr>
        <tr>
          <td class="blue">仕入$</td>
          <td class="blue">OF/TON</td>
          <td class="blue">売値$</td>
        </tr>
        <tr>
          <td class="blue"><div class="cellOut" id="osBuyUsdTonFromSell">—</div></td>
          <td class="blue"><div class="cellOut" id="ofUsdTonB">—</div></td>
          <td class="yellow">
            <input class="cellInput" id="osSellUsd" type="number" inputmode="decimal" step="0.01">
          </td>
        </tr>

        <!-- Bottom inputs -->
        <tr>
          <td class="green" colspan="1"></td>
          <td class="green">為替$</td>
          <td class="green">海上運賃</td>
          <td class="green">積載重量</td>
        </tr>
        <tr>
          <td class="green" colspan="1"></td>
          <td class="yellow">
            <input class="cellInput" id="fx" type="number" inputmode="decimal" step="0.0001">
          </td>
          <td class="yellow">
            <input class="cellInput" id="freight" type="number" inputmode="decimal" step="0.01">
          </td>
          <td class="yellow">
            <input class="cellInput" id="weight" type="number" inputmode="numeric" step="1">
          </td>
        </tr>

        <!-- Bottom outputs -->
        <tr>
          <td class="green" colspan="1"></td>
          <td class="green">OF$/T</td>
          <td class="green">OF$/KG</td>
          <td class="green">OF¥/KG</td>
        </tr>
        <tr>
          <td class="green" colspan="1"></td>
          <td class="green"><div class="cellOut" id="ofUsdTonC">—</div></td>
          <td class="green"><div class="cellOut" id="ofUsdKg">—</div></td>
          <td class="green"><div class="cellOut" id="ofYKg">—</div></td>
        </tr>
      </table>
    </div>

    <div class="small">
      Assumption (same as Excel): Sell ¥/kg = (Buy ¥/kg × 1.1) + 10 + OF ¥/kg
    </div>
  </div>

<script>
  // ========= PIN =========
  const PIN = "1234";
  const pinOverlay = document.getElementById("pinOverlay");
  const pinInput = document.getElementById("pinInput");
  const pinBtn = document.getElementById("pinBtn");
  const pinErr = document.getElementById("pinErr");
  const app = document.getElementById("app");

  function unlock(){
    const entered = (pinInput.value || "").trim();
    if (entered === PIN){
      pinOverlay.classList.add("hidden");
      app.classList.remove("hidden");
      try{ sessionStorage.setItem("be_unlocked","1"); }catch{}
      calcAndRender();
    } else {
      pinErr.textContent = "Wrong PIN";
      pinInput.focus();
    }
  }
  pinBtn.addEventListener("click", unlock);
  pinInput.addEventListener("keydown", e => { if(e.key === "Enter") unlock(); });

  try{
    if(sessionStorage.getItem("be_unlocked")==="1"){
      pinOverlay.classList.add("hidden");
      app.classList.remove("hidden");
    }
  }catch{}

  // ========= Save last inputs =========
  const STORE_KEY = "be_excel_ui_inputs_v1";
  const DEFAULTS = {
    domBuyY: 80,
    domSellUsd: 900,
    osBuyUsd: 800,
    osSellUsd: 1000,
    fx: 155,
    freight: 700,
    weight: 25000
  };

  const el = (id)=>document.getElementById(id);
  const inputIds = Object.keys(DEFAULTS);

  function loadInputs(){
    let saved = null;
    try{ saved = JSON.parse(localStorage.getItem(STORE_KEY) || "null"); }catch{}
    const data = (saved && typeof saved === "object") ? saved : DEFAULTS;
    inputIds.forEach(id => el(id).value = (data[id] ?? DEFAULTS[id]));
  }

  function saveInputs(){
    const data = {};
    inputIds.forEach(id => data[id] = el(id).value);
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(data)); }catch{}
  }

  // ========= Formatting =========
  const nf0 = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
  const nf2 = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function n(v){ const x = Number(v); return Number.isFinite(x) ? x : NaN; }

  function yen0(x){ return Number.isFinite(x) ? "¥" + nf0.format(Math.round(x)) : "—"; }
  function yen2(x){ return Number.isFinite(x) ? "¥" + nf2.format(Math.round(x*100)/100) : "—"; }
  function usd0(x){ return Number.isFinite(x) ? "$" + nf0.format(Math.round(x)) : "—"; }
  function usd2(x){ return Number.isFinite(x) ? "$" + nf2.format(Math.round(x*100)/100) : "—"; }

  // ========= Calculations =========
  function calcAndRender(){
    const domBuyY = n(el("domBuyY").value);
    const domSellUsd = n(el("domSellUsd").value);
    const osBuyUsd = n(el("osBuyUsd").value);
    const osSellUsd = n(el("osSellUsd").value);
    const fx = n(el("fx").value);
    const freight = n(el("freight").value);
    const weight = n(el("weight").value);

    if(!(fx > 0) || !(weight > 0)){
      // keep outputs as —
      return;
    }

    // OF conversions
    const ofUsdKg = freight / weight;
    const ofUsdTon = ofUsdKg * 1000;
    const ofYKg = ofUsdKg * fx;

    // Domestic: from buy (¥/kg) => sell (¥/kg) then $/ton
    const domSellYkgFromBuy = (domBuyY * 1.1) + 10 + ofYKg;
    const domSellUsdTonFromBuy = (domSellYkgFromBuy * 1000) / fx;

    // Domestic: from sell $/ton => sell ¥/kg => BE buy ¥/kg
    const domSellYkgFromSell = (domSellUsd * fx) / 1000;
    const domBuyYFromSell = ((domSellYkgFromSell - ofYKg) - 10) / 1.1;

    // Overseas: from buy => BE sell
    const osSellUsdTonFromBuy = osBuyUsd + ofUsdTon;

    // Overseas: from sell => BE buy
    const osBuyUsdTonFromSell = osSellUsd - ofUsdTon;

    // Render to match Excel look
    el("domSellYkgFromBuy").textContent = yen0(domSellYkgFromBuy);
    el("domSellUsdTonFromBuy").textContent = usd0(domSellUsdTonFromBuy);

    el("domSellYkgFromSell").textContent = yen0(domSellYkgFromSell);
    el("domBuyYFromSell").textContent = yen0(domBuyYFromSell);

    el("ofUsdTonA").textContent = usd0(ofUsdTon);
    el("ofUsdTonB").textContent = usd0(ofUsdTon);
    el("ofUsdTonC").textContent = usd0(ofUsdTon);

    // OF$/KG shown as $0.03 style
    el("ofUsdKg").textContent = usd2(ofUsdKg);
    el("ofYKg").textContent = yen2(ofYKg);

    el("osSellUsdTonFromBuy").textContent = usd0(osSellUsdTonFromBuy);
    el("osBuyUsdTonFromSell").textContent = usd0(osBuyUsdTonFromSell);
  }

  // Wire inputs
  inputIds.forEach(id=>{
    el(id).addEventListener("input", ()=>{
      saveInputs();
      if(app.classList.contains("hidden")) return;
      calcAndRender();
    });
  });

  // Init
  loadInputs();
  if(!app.classList.contains("hidden")){
    calcAndRender();
  } else {
    pinInput.focus();
  }
</script>
</body>
</html>
